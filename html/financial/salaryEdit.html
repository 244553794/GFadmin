<!-- Content Header (页眉) -->
<section class="content-header">
    <h1>员工工资编辑
    	<small>员工工资管理</small>
    </h1>
    <ol class="breadcrumb">
        <li><a><i class="fa fa-dashboard"></i> 首页</a></li>
        <li><a>工资管理</a></li>
        <li class="active">编辑信息</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div class="callout callout-info">
      <h4>提示！</h4>
      <p>单个员工工资编辑</p>
    </div>
    <!--基本信息-->
    <div class="box">
    	<div class="box-header with-border">
        	<h3 class="box-title">员工基本信息</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="折叠" onClick="hidebox(this)"><i class="fa fa-minus"></i></button>
                <button type="button" id="reflash" class="btn btn-box-tool" title="刷新，注意保存信息" onClick="jumpURL(this)" url="/html/financial/salaryEdit.html" param=""><i class="fa fa-refresh" aria-hidden="true"></i></button>
            </div>
        </div>
        <div class="box-body">
            <!--内容    -->
            <div class="col-xs-4" style="line-height: 50px;">员工编号：<span id="empNum"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">员工姓名：<span id="empRealname"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">出生年月：<span id="birthdate"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">性别：<span id="sex"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">身份证号：<span id="idCard"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">电话：<span id="phone"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">员工类别：<span id="empType"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">入职部门：<span id="departName"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">入职岗位：<span id="job"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">护卫点项目：<span id="projectName"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">分管负责人：<span id="firstPersonName"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">合同开始时间：<span id="contractStarttime"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">合同结束时间：<span id="contractEndtime"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">入职时间：<span id="hiredate"></span></div>
            <div class="col-xs-4" style="line-height: 50px;">试用期：<span id="probationPeriod"></span></div>
        </div>
    </div>
    <!--添加第二个面板-->
    <div class="box">
    	<div class="box-header with-border">
        	<h3 class="box-title">工资制作</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="折叠" onClick="hidebox(this)"><i class="fa fa-minus"></i></button>
            </div>
        </div>
        <form>
        <div class="box-body">
            <!--内容    -->
            <div class="col-xs-12">
                <div class="input-group" style="margin-bottom:20px;width: 100%;">
                    <div class="input-group" style="margin-bottom:20px;">
                        <span class="input-group-addon" style="background-color:#f1f1f1;"><div>工资日期</div></span>
                        <input type="text" class="form-control" name="salaryDate" id="salaryDate" value="" style="font-size: 24px; color: red;font-weight: bold; background-color: #FFF;" onchange="fillform()" readonly>
                        <error></error>
                    </div>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">定薪【+】</div></span>
                    <input type="text" class="form-control" placeholder="定薪" name="hiredateMoney" id="hiredateMoney" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">伙食补助【+】</div></span>
                    <input type="text" class="form-control" placeholder="伙食补助" name="foodAllowance" id="foodAllowance" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">通讯津贴【+】</div></span>
                    <input type="text" class="form-control" placeholder="通讯津贴" name="phoneAllowance" id="phoneAllowance" value="">
                    <error></error>
                </div>
            </div>
            
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">交通补贴【+】</div></span>
                    <input type="text" class="form-control" placeholder="交通补贴" name="trafficAllowance" id="trafficAllowance" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">其他【+】</div></span>
                    <input type="text" class="form-control" placeholder="其他" name="otherMoney" id="otherMoney" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">水电【-】</div></span>
                    <input type="text" class="form-control" placeholder="水电" name="waterElectricityDeductions" id="waterElectricityDeductions" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">伙食费【-】</div></span>
                    <input type="text" class="form-control" placeholder="伙食费" name="foodDeductions" id="foodDeductions" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">违纪【-】</div></span>
                    <input type="text" class="form-control" placeholder="违纪" name="discipline" id="discipline" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">代扣【-】</div></span>
                    <input type="text" class="form-control" placeholder="代扣" name="withhold" id="withhold" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">保险【-】</div></span>
                    <input type="text" class="form-control" placeholder="保险" name="securityMoney" id="securityMoney" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">公积金【-】</div></span>
                    <input type="text" class="form-control" placeholder="公积金" name="accumulationFundMoney" id="accumulationFundMoney" value="">
                    <error></error>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="input-group" style="margin-bottom:20px;">
                    <span class="input-group-addon" style="background-color:#f1f1f1; "><div style="width:130px;">个税【-】</div></span>
                    <input type="text" class="form-control" placeholder="个税" name="individualIncomeTax" id="individualIncomeTax" value="">
                    <error></error>
                </div>
            </div>
        </div>
        <div class="box-foot with-border" style="border-top: 1px #CCC solid; height: 60px;">
            <div class="col-xs-6">
                应发工资：<span style="color: red">￥</span><b style="font-size: 24px;color: red" id="shouldMoney">0</b>
                <input type="hidden" name="shouldMoney" value="">
            </div>
            <div class="col-xs-6">
                实发工资：<span style="color: green">￥</span><b style="font-size: 24px;color: green" id="realMoney">0</b>
                <input type="hidden" name="realMoney" value="">
            </div>
        </div>
        <input type="hidden" name="empid" id="empid" value="">
        <input type="hidden" name="id" id="id" value="">
        </form>
    </div>
    <!--底部-->
    
    <div class="box-footer" style="position:fixed; left:0px; bottom:0px; width:100%; height:60px;box-shadow: 0px 0px 40px #888888; z-index:9; background-color:#FFF;">
    <p><error></error></p><button type="button" class="btn btn-primary fl_right" style="width:150px; margin-right:50px;" onClick="updateSalary()">保存提交</button><button type="button" class="btn btn-default fl_right" style="width:150px; margin-right:50px;" onClick="jumpURL(this)" url="/html/financial/salaryList.html" param="">返回列表</button>
    </div>
</section>
<script>
$("#salaryDate").datepicker({
          language: "zh-CN",
          todayHighlight: true,
          format: 'yyyy-mm',
          autoclose: true,
          startView: 'months',
          maxViewMode:'years',
          minViewMode:'months'
});
//填充表单
var param = $("#ajaxcontent").attr("param");
param = param.replace(/'/g,"\"");
$("#reflash").attr("param",param);
param = JSON.parse(param);
$("#salaryDate").val(param.hireDate);
$("#empid").val(param.id);

fillform()

function fillform(){
    var url = depUrl + "/salary/getsalaryList";
    
    var empid = param.id;
    var startTime = $("#salaryDate").val();
    var endTime = $("#salaryDate").val();
    
    $.ajax({
		type: 'POST',
		url: url,
		data: {"empId":empid,"startTime":startTime,"endTime":endTime},
		dataType: "json",
		ontentType:"application/x-www-form-urlencoded",
		headers:{accessToken:$.session.get('accessToken')},
		success: function(data){
			var code = data.code;
			if(code=="000000"){
                $.each(data.data.list,function(i,items){
                    $("#empNum").text(outNull(items.empNum));
                    $("#empRealname").text(outNull(items.empRealname));
                    $("#birthdate").text(outNull(items.birthdate));
                    $("#sex").text(outNull(items.sex));
                    $("#idCard").text(outNull(items.idCard));
                    $("#phone").text(outNull(items.phone));
                    $("#empType").text(outNull(items.empType));
                    $("#departName").text(outNull(items.departName));
                    $("#job").text(outNull(items.job));
                    $("#projectName").text(outNull(items.projectName));
                    $("#contractStarttime").text(outNull(items.contractStarttime));
                    $("#contractEndtime").text(outNull(items.contractEndtime));
                    $("#hiredate").text(outNull(items.hiredate));
                    $("#probationPeriod").text(outNull(items.probationPeriod));
                    $("#firstPersonName").text(outNull(items.firstPersonName));
                    //工资信息
                    $("#id").val(outNull(items.empSalary.id));
                    $("#hiredateMoney").val(outNull(items.empSalary.hiredateMoney));
                    $("#foodAllowance").val(outNull(items.empSalary.foodAllowance));
                    $("#phoneAllowance").val(outNull(items.empSalary.phoneAllowance));
                    $("#trafficAllowance").val(outNull(items.empSalary.trafficAllowance));
                    $("#otherMoney").val(outNull(items.empSalary.otherMoney));
                    $("#waterElectricityDeductions").val(outNull(items.empSalary.waterElectricityDeductions));
                    $("#foodDeductions").val(outNull(items.empSalary.foodDeductions));
                    $("#discipline").val(outNull(items.empSalary.discipline));
                    $("#withhold").val(outNull(items.empSalary.withhold));
                    $("#securityMoney").val(outNull(items.empSalary.securityMoney));
                    $("#accumulationFundMoney").val(outNull(items.empSalary.accumulationFundMoney));
                    $("#individualIncomeTax").val(outNull(items.empSalary.individualIncomeTax));
                    $("input[name=shouldMoney]").val(outNull(items.empSalary.shouldMoney));
                    $("input[name=realMoney]").val(outNull(items.empSalary.realMoney));
                    $("#shouldMoney").text(outNull(items.empSalary.shouldMoney));
                    $("#realMoney").text(outNull(items.empSalary.realMoney));
                });
			}else{
				$(".box-footer error").text("* 错误提示："+ data.msg +"！");
			}
		},
		error:function(data){
			$(".box-footer error").text("* 错误提示："+ data.msg +"！");
			return false;
		}
	});
}
//修改员工薪资
function updateSalary(){
    var id = $("#id").val();
    var startTime = $("#salaryDate").val();
    var endTime = $("#salaryDate").val();
    //获取表单上数据
    var d = {};
    var t = $('form').serializeArray();
    $.each(t, function() {
          d[this.name] = this.value;
    });
    console.log(JSON.stringify(d));
    var url =  depUrl + "/salary/updateSalary";
    
    $.ajax({
		type: 'POST',
		url: url,
		data: JSON.stringify(d),
		dataType: "json",
		contentType:"application/json;charset=utf-8",
		headers:{accessToken:$.session.get('accessToken')},
		success: function(data){
			var code = data.code;
			if(code=="000000"){
                if(!confirm("保存成功！确定继续添加，取消返回列表?")){
                    autoJumpURL('/html/financial/salaryList.html');
                }
			}else{
				$(".box-footer error").text("* 错误提示："+ data.msg +"！");
			}
		},
		error:function(data){
			$(".box-footer error").text("* 错误提示："+ data.msg +"！");
			return false;
		}
	});
}
//计算薪资
$(".box-body").find(".col-xs-4").find("input").change(function(){
    var hiredateMoney = parseFloat($("#hiredateMoney").val());
    var foodAllowance = parseFloat($("#foodAllowance").val());
    var phoneAllowance = parseFloat($("#phoneAllowance").val());
    var trafficAllowance = parseFloat($("#trafficAllowance").val());
    var otherMoney = parseFloat($("#otherMoney").val());
    var waterElectricityDeductions = parseFloat($("#waterElectricityDeductions").val());
    var foodDeductions = parseFloat($("#foodDeductions").val());
    var discipline = parseFloat($("#discipline").val());
    var withhold = parseFloat($("#withhold").val());
    var securityMoney = parseFloat($("#securityMoney").val());
    var accumulationFundMoney = parseFloat($("#accumulationFundMoney").val());
    var individualIncomeTax = parseFloat($("#individualIncomeTax").val());
    
    var shouldMoney = 0;
    var realMoney = 0;
    
    shouldMoney = hiredateMoney + foodAllowance + phoneAllowance + trafficAllowance + otherMoney - waterElectricityDeductions - foodDeductions - discipline - withhold;
    realMoney = shouldMoney - securityMoney - accumulationFundMoney - individualIncomeTax;
    
    $("input[name=shouldMoney]").val(shouldMoney);
    $("input[name=realMoney]").val(realMoney);
    $("#shouldMoney").text(shouldMoney);
    $("#realMoney").text(realMoney);
});
</script>